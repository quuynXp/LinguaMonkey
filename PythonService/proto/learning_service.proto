syntax = "proto3";

package learning;

// =====================
// Common / Base Messages
// =====================
message MediaRef {
  oneof source {
    string url = 1;
    bytes inline_data = 2;
  }
  string mime_type = 3;
  int64 size = 4;
}

message Metadata {
  map<string, string> fields = 1;
}

// =====================
// Core LearningService
// =====================
service LearningService {

  // --- Speech & Audio ---
  rpc SpeechToText (SpeechRequest) returns (SpeechResponse);
  rpc GenerateTts (TtsRequest) returns (TtsResponse);
  rpc CheckPronunciation (PronunciationRequest) returns (PronunciationResponse);

  rpc StreamPronunciation (stream PronunciationChunk) returns (stream PronunciationChunkResponse);

  // --- Text-based ---
  rpc CheckSpelling (SpellingRequest) returns (SpellingResponse);
  rpc CheckTranslation (CheckTranslationRequest) returns (CheckTranslationResponse);
  rpc CheckWritingWithImage (WritingImageRequest) returns (WritingImageResponse);
  rpc ChatWithAI (ChatRequest) returns (ChatResponse);

  // âœ… New rpc for translation (used by Java client)
  rpc Translate (TranslateRequest) returns (TranslateResponse);

  // --- Content Generation ---
  rpc GenerateImage (GenerateImageRequest) returns (GenerateImageResponse);
  rpc GenerateText (GenerateTextRequest) returns (GenerateTextResponse);
  rpc GeneratePassage (GeneratePassageRequest) returns (GeneratePassageResponse);

  // --- Personalized Learning ---
  rpc CreateOrUpdateRoadmap (RoadmapRequest) returns (RoadmapResponse);
  rpc CreateOrUpdateRoadmapDetailed (RoadmapDetailedRequest) returns (RoadmapDetailedResponse);

  // --- System-level / analytics ---
  rpc AnalyzeCourseQuality (CourseQualityRequest) returns (CourseQualityResponse);
  rpc RefundDecision (RefundDecisionRequest) returns (RefundDecisionResponse);
}

// =====================
// Translation
// =====================
message TranslateRequest {
  string text = 1;
  string source_language = 2;
  string target_language = 3;
  Metadata metadata = 4;
}

message TranslateResponse {
  string translated_text = 1;
  string source_language_detected = 2;
  float confidence = 3;
  string error = 4;
}

// =====================
// Audio
// =====================
message SpeechRequest {
  MediaRef audio = 1;
  string language = 2;
  Metadata metadata = 3;
}

message SpeechResponse {
  string text = 1;
  string error = 2;
}

message TtsRequest {
  string text = 1;
  string language = 2;
  Metadata metadata = 3;
}

message TtsResponse {
  bytes audio_data = 1;
  string audio_url = 2;
  string error = 3;
}

message PronunciationRequest {
  string user_id = 1;
  MediaRef audio = 2;
  string language = 3;
  Metadata metadata = 4;
}

message PronunciationResponse {
  string feedback = 1;
  float score = 2;
  string ipa = 3;
  string suggestion = 4;
  string error = 5;
}

// Streaming pronunciation
message PronunciationChunk {
  bytes audio_chunk = 1;
  int32 sequence = 2;
  bool is_final = 3;
}

message PronunciationChunkResponse {
  float score = 1;
  string feedback = 2;
  bool is_final = 3;
}

// =====================
// Text / Writing / Grammar
// =====================
message SpellingRequest {
  string text = 1;
  string language = 2;
  Metadata metadata = 3;
}

message SpellingResponse {
  repeated string corrections = 1;
  string explanation = 2;
  string error = 3;
}

message CheckTranslationRequest {
  string reference_text = 1;
  string translated_text = 2;
  string target_language = 3;
  Metadata metadata = 4;
}

message CheckTranslationResponse {
  string feedback = 1;
  float score = 2;
  string error = 3;
}

message WritingImageRequest {
  string text = 1;
  MediaRef image = 2;
  string language = 3;
  Metadata metadata = 4;
}

message WritingImageResponse {
  string feedback = 1;
  float score = 2;
  repeated string suggestions = 3;
  string error = 4;
}

// =====================
// Chat / Conversation
// =====================
message ChatMessage {
  string role = 1;
  string content = 2;
}

message ChatRequest {
  string user_id = 1;
  string message = 2;
  repeated ChatMessage history = 3;
  Metadata metadata = 4;
}

message ChatResponse {
  string response = 1;
  repeated string suggestions = 2;
  string emotion = 3;
  string error = 4;
}

// =====================
// Generation (AI)
// =====================
message GenerateImageRequest {
  string user_id = 1;
  string prompt = 2;
  string language = 3;
  Metadata metadata = 4;
}

message GenerateImageResponse {
  repeated string image_urls = 1;
  string model_used = 2;
  string error = 3;
}

message GenerateTextRequest {
  string user_id = 1;
  string prompt = 2;
  string language = 3;
  Metadata metadata = 4;
}

message GenerateTextResponse {
  string text = 1;
  repeated string suggestions = 2;
  string error = 3;
}

message GeneratePassageRequest {
  string user_id = 1;
  string language = 2;
  string topic = 3;
  Metadata metadata = 4;
}

message GeneratePassageResponse {
  string passage = 1;
  string difficulty = 2;
  string error = 3;
}

// =====================
// Roadmap / Learning Path
// =====================
message RoadmapItemProto {
  string item_id = 1;
  string title = 2;
  string description = 3;
  string type = 4;
  int32 level = 5;
  int32 estimated_time = 6;
  int32 order_index = 7;
  string category = 8;
  string difficulty = 9;
  int32 exp_reward = 10;
  string content_id = 11;
}

message RoadmapRequest {
  string user_id = 1;
  string roadmap_id = 2;
  string title = 3;
  string description = 4;
  string language = 5;
}

message RoadmapResponse {
  string roadmap_id = 1;
  string title = 2;
  string description = 3;
  string language = 4;
  string error = 5;
}

message RoadmapDetailedRequest {
  string user_id = 1;
  string roadmap_id = 2;
  string language = 3;
  string prompt = 4;
  bool as_user_specific = 5;
  Metadata metadata = 6;
}

message RoadmapDetailedResponse {
  string roadmap_id = 1;
  string title = 2;
  string description = 3;
  string language = 4;
  repeated RoadmapItemProto items = 5;
  string error = 6;
}

// =====================
// Course Quality / Refunds
// =====================
message CourseQualityRequest {
  string course_id = 1;
  repeated string lesson_ids = 2;
  Metadata metadata = 3;
}

message CourseQualityResponse {
  float quality_score = 1;
  repeated string warnings = 2;
  string verdict = 3;
  string error = 4;
}

message RefundDecisionRequest {
  string transaction_id = 1;
  string user_id = 2;
  string course_id = 3;
  string reason_text = 4;
  Metadata metadata = 5;
}

message RefundDecisionResponse {
  string decision = 1;
  string label = 2;
  float confidence = 3;
  repeated string explanations = 4;
  string error = 5;
}
