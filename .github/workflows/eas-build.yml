name: LinguamonkeyFe - Signed APK Build (Final Resource Fix)



on:

  push:

    paths:

      - "LinguamonkeyFe/**"

    branches:

      - master

  workflow_dispatch:



jobs:

  build-android:

    runs-on: ubuntu-latest

    defaults:

      run:

        working-directory: ./LinguamonkeyFe



    steps:

      - name: üß± Checkout repository

        uses: actions/checkout@v4



      - name: üóëÔ∏è AGGRESSIVE DISK CLEANUP

        run: |

          sudo rm -rf /usr/share/dotnet

          sudo rm -rf /opt/hostedtoolcache/CodeQL

          sudo docker image prune --all --force

          sudo apt-get clean

          sudo rm -rf /tmp/*

          sudo rm -rf /usr/local/lib/android/sdk/system-images



      - name: üß© Setup Node.js

        uses: actions/setup-node@v4

        with:

          node-version: 22

          cache: 'yarn'

          cache-dependency-path: ./LinguamonkeyFe/yarn.lock



      - name: üì¶ Install dependencies

        run: yarn install --frozen-lockfile



      - name: üí£ Delete existing Android folder

        run: rm -rf android



      - name: üõ†Ô∏è Generate Android directory (Prebuild)

        run: npx expo prebuild --platform android --no-install



      # --- B∆Ø·ªöC 1: C√†i CMake 3.28.1 th·ªß c√¥ng (ƒê√É CH·∫†Y NGON) ---

      - name: üîß Install CMake 3.28.1

        run: |

          echo "‚¨áÔ∏è Downloading CMake 3.28.1..."

          wget -q https://github.com/Kitware/CMake/releases/download/v3.28.1/cmake-3.28.1-linux-x86_64.tar.gz -O cmake.tar.gz

          

          # C√†i ƒë·∫∑t v√†o ƒë√∫ng ch·ªó Android SDK mong ƒë·ª£i

          sudo mkdir -p $ANDROID_HOME/cmake/3.28.1

          sudo tar -xf cmake.tar.gz -C $ANDROID_HOME/cmake/3.28.1 --strip-components=1

          rm cmake.tar.gz

          

          echo "‚úÖ CMake 3.28.1 installed at $ANDROID_HOME/cmake/3.28.1"



      # --- B∆Ø·ªöC 2: Init Script √©p Version (ƒê√É CH·∫†Y NGON) ---

      - name: üíâ Create Gradle Init Script

        run: |

          cat <<EOF > cmake_fix.gradle

          allprojects {

              afterEvaluate { project ->

                  if (project.hasProperty("android")) {

                      android {

                          externalNativeBuild {

                              cmake {

                                  version "3.28.1"

                              }

                          }

                      }

                  }

              }

          }

          EOF



      # --- B∆Ø·ªöC 3: FIX OOM (QUAN TR·ªåNG NH·∫§T L√öC N√ÄY) ---

      - name: üöÄ Configure Gradle Memory & Workers

        run: |

          # 1. Gi·∫£m Xmx xu·ªëng 3072m (3GB) ƒë·ªÉ d√†nh 4GB c√≤n l·∫°i cho ti·∫øn tr√¨nh C++ (Clang/Ninja)

          # 2. Quan tr·ªçng: org.gradle.workers.max=1 -> Ch·∫°y tu·∫ßn t·ª± ƒë·ªÉ kh√¥ng n·ªï RAM

          echo -e "\norg.gradle.jvmargs=-Xmx3072m -XX:MaxMetaspaceSize=512m -Dkotlin.daemon.jvm.options=\"-Xmx1024m\"" >> ./android/gradle.properties

          echo "org.gradle.workers.max=1" >> ./android/gradle.properties

          echo "android.enableR8=true" >> ./android/gradle.properties

          

          # Ki·ªÉm tra file ƒë√£ ghi ch∆∞a

          cat ./android/gradle.properties



      - name: üßπ Clean up duplicate icon files

        run: |

          if [ -d "./android/app/src/main/res" ]; then

            find ./android/app/src/main/res -name "*.webp" -delete

          fi



      - name: ‚òï Setup Java (JDK)

        uses: actions/setup-java@v4

        with:

          distribution: 'temurin'

          java-version: '17'

          

      - name: üêò Cache Gradle dependencies

        uses: actions/cache@v4

        with:

          path: |

            ~/.gradle/caches

            ~/.gradle/wrapper

          key: ${{ runner.os }}-gradle-fe-v9-${{ hashFiles('LinguamonkeyFe/**/*.gradle*', 'LinguamonkeyFe/**/gradle-wrapper.properties') }}

          restore-keys: |

            ${{ runner.os }}-gradle-fe-v9-



      - name: üîê Setup Keystore

        run: |

          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > ./android/app/my-release-key.keystore



      - name: ‚öôÔ∏è Build APK with Gradle

        env:

          ORG_GRADLE_PROJECT_MYAPP_UPLOAD_STORE_FILE: my-release-key.keystore

          ORG_GRADLE_PROJECT_MYAPP_UPLOAD_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

          ORG_GRADLE_PROJECT_MYAPP_UPLOAD_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}

          ORG_GRADLE_PROJECT_MYAPP_UPLOAD_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

        run: |

          cd android

          chmod +x gradlew

          

          echo "üî® Starting Build with Limited Concurrency..."

          

          # Th√™m --no-daemon ƒë·ªÉ gi·∫£m memory footprint sau khi ch·∫°y xong task

          ./gradlew assembleRelease --init-script ../cmake_fix.gradle --no-daemon \

            -Pandroid.injected.signing.store.file=$(pwd)/app/my-release-key.keystore \

            -Pandroid.injected.signing.store.password=${{ secrets.ANDROID_KEYSTORE_PASSWORD }} \

            -Pandroid.injected.signing.key.alias=${{ secrets.ANDROID_KEY_ALIAS }} \

            -Pandroid.injected.signing.key.password=${{ secrets.ANDROID_KEY_PASSWORD }}



      - name: üì§ Upload signed APK

        uses: actions/upload-artifact@v4

        with:

          name: android-signed-apk

          path: LinguamonkeyFe/android/app/build/outputs/apk/release/app-release.apk



      - name: üßπ Final Clean Up

        if: always()

        run: rm -f ./android/app/my-release-key.keystore