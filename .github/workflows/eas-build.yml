name: LinguamonkeyFe - Signed APK Build (Final SDK Fix)



on:

  push:

    paths:

      - "LinguamonkeyFe/**"

    branches:

      - master

  workflow_dispatch:



jobs:

  build-android:

    runs-on: ubuntu-latest

    defaults:

      run:

        working-directory: ./LinguamonkeyFe



    steps:

      - name: üß± Checkout repository

        uses: actions/checkout@v4



      - name: üóëÔ∏è AGGRESSIVE DISK CLEANUP

        run: |

          sudo rm -rf /usr/share/dotnet

          sudo rm -rf /opt/hostedtoolcache/CodeQL

          sudo docker image prune --all --force

          sudo apt-get clean

          sudo rm -rf /tmp/*

          sudo rm -rf /usr/local/lib/android/sdk/system-images



      - name: üß© Setup Node.js

        uses: actions/setup-node@v4

        with:

          node-version: 22

          cache: 'yarn'

          cache-dependency-path: ./LinguamonkeyFe/yarn.lock



      - name: üì¶ Install dependencies

        run: yarn install --frozen-lockfile



      - name: üí£ Delete existing Android folder

        run: rm -rf android



      - name: üõ†Ô∏è Generate Android directory (Prebuild)

        run: npx expo prebuild --platform android --no-install



      - name: üöÄ Configure Gradle Memory (Fix Daemon Start)

        run: |

          echo "org.gradle.jvmargs=-Xmx4g -XX:+HeapDumpOnOutOfMemoryError -Dkotlin.daemon.jvm.options=\"-Xmx2g\"" >> ./android/gradle.properties

          echo "android.enableR8=true" >> ./android/gradle.properties



      - name: üßπ Clean up duplicate icon files

        run: |

          if [ -d "./android/app/src/main/res" ]; then

            find ./android/app/src/main/res -name "*.webp" -delete

          fi



      - name: ‚òï Setup Java (JDK)

        uses: actions/setup-java@v4

        with:

          distribution: 'temurin'

          java-version: '17'

          

      - name: üêò Cache Gradle dependencies

        uses: actions/cache@v4

        with:

          path: |

            ~/.gradle/caches

            ~/.gradle/wrapper

          key: ${{ runner.os }}-gradle-fe-v4-${{ hashFiles('LinguamonkeyFe/**/*.gradle*', 'LinguamonkeyFe/**/gradle-wrapper.properties') }}

          restore-keys: |

            ${{ runner.os }}-gradle-fe-v4-



      - name: üîê Setup Keystore

        run: |

          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > ./android/app/my-release-key.keystore



      - name: ‚öôÔ∏è Build APK with Gradle

        env:

          ORG_GRADLE_PROJECT_MYAPP_UPLOAD_STORE_FILE: my-release-key.keystore

          ORG_GRADLE_PROJECT_MYAPP_UPLOAD_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

          ORG_GRADLE_PROJECT_MYAPP_UPLOAD_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}

          ORG_GRADLE_PROJECT_MYAPP_UPLOAD_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

        run: |

          cd android

          chmod +x gradlew

          ./gradlew assembleRelease \

            -Pandroid.injected.signing.store.file=$(pwd)/app/my-release-key.keystore \

            -Pandroid.injected.signing.store.password=${{ secrets.ANDROID_KEYSTORE_PASSWORD }} \

            -Pandroid.injected.signing.key.alias=${{ secrets.ANDROID_KEY_ALIAS }} \

            -Pandroid.injected.signing.key.password=${{ secrets.ANDROID_KEY_PASSWORD }}



      - name: üì§ Upload signed APK

        uses: actions/upload-artifact@v4

        with:

          name: android-signed-apk

          path: LinguamonkeyFe/android/app/build/outputs/apk/release/app-release.apk



      - name: üßπ Final Clean Up

        if: always()

        run: rm -f ./android/app/my-release-key.keystore