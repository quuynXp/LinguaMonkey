name: LinguamonkeyFe - Signed APK Build (Local EAS)

on:
  push:
    paths:
      - "LinguamonkeyFe/**"
    branches:
      - master
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./LinguamonkeyFe

    steps:
      - name: üß± Checkout repository
        uses: actions/checkout@v4

      - name: üß© Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'yarn'
          cache-dependency-path: ./LinguamonkeyFe/yarn.lock

      - name: üì¶ Install dependencies
        run: yarn install --frozen-lockfile

      - name: üõ†Ô∏è Generate Android directory (Prebuild)
        run: npx expo prebuild --platform android --no-install

      # B∆∞·ªõc n√†y x√≥a file webp ƒë·ªÉ tr√°nh l·ªói tr√πng l·∫∑p resource
      - name: üßπ Clean up duplicate icon files
        run: |
          echo "‚ú® Cleaning up duplicate icon files (removing .webp)..."
          find ./android/app/src/main/res -name "*.webp" -delete

      - name: ‚òï Setup Java (JDK)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # --- B∆Ø·ªöC KH·∫ÆC PH·ª§C L·ªñI NDK 27 ---
      # X√≥a s·∫°ch b·∫£n 27 ƒë·ªÉ Gradle kh√¥ng c√≤n l·ª±a ch·ªçn n√†o kh√°c ngo√†i d√πng b·∫£n 26
      - name: üóëÔ∏è Force remove NDK 27 & Setup NDK 26
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          add-to-path: true
      
      - name: üí£ Delete conflicting NDK versions
        run: |
          echo "Checking for NDK versions..."
          ls -al $ANDROID_HOME/ndk/ || true
          
          echo "üóëÔ∏è DELETING NDK 27 to force CMake to use NDK 26..."
          sudo rm -rf $ANDROID_HOME/ndk/27.*
          sudo rm -rf /usr/local/lib/android/sdk/ndk/27.*
          
          echo "‚úÖ Remaining NDK versions:"
          ls -al $ANDROID_HOME/ndk/

      # Ghi ƒë√® file local.properties ƒë·ªÉ tr·ªè th·∫≥ng v√†o NDK c√†i ƒë·∫∑t
      - name: üìç Force Local Properties to NDK 26
        run: |
          echo "ndk.dir=${{ steps.setup-ndk.outputs.ndk-path }}" >> ./android/local.properties
          cat ./android/local.properties

      # ---------------------------------

      - name: üêò Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-fe-${{ hashFiles('LinguamonkeyFe/**/*.gradle*', 'LinguamonkeyFe/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-fe-
            
      - name: üßπ Clean up large components
        run: |
          sudo rm -rf /usr/share/dotnet/
          sudo apt-get clean

      - name: üîê Install EAS CLI
        run: npm install -g eas-cli

      - name: üîë Decode Android keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > my-release-key.keystore
          chmod 600 my-release-key.keystore

      - name: ‚öôÔ∏è Build signed APK locally
        env:
          EXPO_TOKEN: ${{ secrets.EAS_TOKEN }}
          ANDROID_KEYSTORE_PATH: ./my-release-key.keystore
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          # √âp bu·ªôc bi·∫øn m√¥i tr∆∞·ªùng l·∫ßn n·ªØa
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          echo "üîß Start signed local EAS build..."
          # --skip-project-configuration: Gi·ªØ nguy√™n ƒë·ªÉ kh√¥ng b·ªã ƒë√® file webp
          eas build --platform android --profile production-apk --local --non-interactive --output ./app-release.apk --skip-project-configuration

      - name: üì§ Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: android-signed-apk
          path: LinguamonkeyFe/app-release.apk