name: LinguamonkeyFe - Signed APK Build (Final SDK Fix)



on:

  push:

    paths:

      - "LinguamonkeyFe/**"

    branches:

      - master

  workflow_dispatch:



jobs:

  build-android:

    runs-on: ubuntu-latest

    defaults:

      run:

        working-directory: ./LinguamonkeyFe



    steps:

      - name: üß± Checkout repository

        uses: actions/checkout@v4



      - name: üóëÔ∏è AGGRESSIVE DISK CLEANUP

        run: |

          sudo rm -rf /usr/share/dotnet

          sudo rm -rf /opt/hostedtoolcache/CodeQL

          sudo docker image prune --all --force

          sudo apt-get clean

          sudo rm -rf /tmp/*

          sudo rm -rf /usr/local/lib/android/sdk/system-images



      - name: üß© Setup Node.js

        uses: actions/setup-node@v4

        with:

          node-version: 22

          cache: 'yarn'

          cache-dependency-path: ./LinguamonkeyFe/yarn.lock



      - name: üì¶ Install dependencies

        run: yarn install --frozen-lockfile



      - name: üí£ Delete existing Android folder

        run: rm -rf android



      - name: üõ†Ô∏è Generate Android directory (Prebuild)

        run: npx expo prebuild --platform android --no-install



      # --- B∆Ø·ªöC M·ªöI: C√†i CMake 3.28+ v√† c·∫•u h√¨nh local.properties ---

      - name: üîß Setup CMake 3.28

        uses: jwlawson/actions-setup-cmake@v2

        with:

          cmake-version: '3.28.3'



      - name: üìù Configure local.properties (Force CMake & SDK)

        run: |

          # T√¨m ƒë∆∞·ªùng d·∫´n CMake v·ª´a c√†i

          CMAKE_BIN=$(which cmake)

          # L·∫•y th∆∞ m·ª•c g·ªëc c·ªßa CMake (lo·∫°i b·ªè /bin/cmake)

          CMAKE_ROOT=$(dirname $(dirname $CMAKE_BIN))

          

          echo "üî• Detected Custom CMake at: $CMAKE_ROOT"

          

          # Ghi v√†o local.properties ƒë·ªÉ √©p Gradle d√πng b·∫£n n√†y

          echo "sdk.dir=$ANDROID_HOME" > ./android/local.properties

          echo "cmake.dir=$CMAKE_ROOT" >> ./android/local.properties



      - name: üöÄ Configure Gradle Memory

        run: |

          # X√≥a c·∫•u h√¨nh enableR8 ƒë√£ l·ªói th·ªùi v√† th√™m c·∫•u h√¨nh b·ªô nh·ªõ v·ªõi newline

          echo -e "\norg.gradle.jvmargs=-Xmx4g -XX:+HeapDumpOnOutOfMemoryError -Dkotlin.daemon.jvm.options=\"-Xmx2g\"" >> ./android/gradle.properties



      - name: üßπ Clean up duplicate icon files

        run: |

          if [ -d "./android/app/src/main/res" ]; then

            find ./android/app/src/main/res -name "*.webp" -delete

          fi



      - name: ‚òï Setup Java (JDK)

        uses: actions/setup-java@v4

        with:

          distribution: 'temurin'

          java-version: '17'

          

      - name: üêò Cache Gradle dependencies

        uses: actions/cache@v4

        with:

          path: |

            ~/.gradle/caches

            ~/.gradle/wrapper

          key: ${{ runner.os }}-gradle-fe-v6-${{ hashFiles('LinguamonkeyFe/**/*.gradle*', 'LinguamonkeyFe/**/gradle-wrapper.properties') }}

          restore-keys: |

            ${{ runner.os }}-gradle-fe-v6-



      - name: üîê Setup Keystore

        run: |

          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > ./android/app/my-release-key.keystore



      - name: ‚öôÔ∏è Build APK with Gradle

        env:

          ORG_GRADLE_PROJECT_MYAPP_UPLOAD_STORE_FILE: my-release-key.keystore

          ORG_GRADLE_PROJECT_MYAPP_UPLOAD_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

          ORG_GRADLE_PROJECT_MYAPP_UPLOAD_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}

          ORG_GRADLE_PROJECT_MYAPP_UPLOAD_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

        run: |

          cd android

          chmod +x gradlew

          ./gradlew assembleRelease \

            -Pandroid.injected.signing.store.file=$(pwd)/app/my-release-key.keystore \

            -Pandroid.injected.signing.store.password=${{ secrets.ANDROID_KEYSTORE_PASSWORD }} \

            -Pandroid.injected.signing.key.alias=${{ secrets.ANDROID_KEY_ALIAS }} \

            -Pandroid.injected.signing.key.password=${{ secrets.ANDROID_KEY_PASSWORD }}



      - name: üì§ Upload signed APK

        uses: actions/upload-artifact@v4

        with:

          name: android-signed-apk

          path: LinguamonkeyFe/android/app/build/outputs/apk/release/app-release.apk



      - name: üßπ Final Clean Up

        if: always()

        run: rm -f ./android/app/my-release-key.keystore