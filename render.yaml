services:
  # === 1. BACKEND (JAVA) ===
  - type: web
    name: linguavietnameseapp
    runtime: docker
    region: singapore
    plan: free
    dockerfilePath: ./LinguaVietnameseApp/Dockerfile
    dockerContext: .
    healthCheckPath: /actuator/health
    numInstances: 1
    disk:
      name: app_data
      mountPath: /var/lib/app_data
      sizeGB: 1

    # Mount secret files (Upload these in Render Dashboard)
    secretFiles:
      - name: service-account-key.json
        mountPath: /etc/secrets/service-account-key.json
      - name: gdrive-key.json
        mountPath: /etc/secrets/gdrive-key.json

    envVars:
      - key: TZ
        value: Asia/Ho_Chi_Minh
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      - key: SERVER_PORT
        value: 8080
      - key: PORT
        value: 8080

      # Database Linking
      - key: DB_HOST
        fromDatabase:
          name: linguaviet-db
          property: host
      - key: DB_PORT
        fromDatabase:
          name: linguaviet-db
          property: port
      - key: DB_NAME
        fromDatabase:
          name: linguaviet-db
          property: database
      - key: DB_USERNAME
        fromDatabase:
          name: linguaviet-db
          property: user
      - key: DB_PASSWORD
        fromDatabase:
          name: linguaviet-db
          property: password
      - key: DB_URL
        value: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}

      # Redis Linking
      - key: REDIS_HOST
        fromService:
          type: redis
          name: redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: redis
          name: redis
          property: port
      - key: REDIS_PASSWORD
        value: redisPass123
      - key: REDIS_SSL
        value: false

      # Internal Service Communication
      - key: PYTHON_SERVICE_URL
        value: http://pythonservice:8001
      - key: PYTHON_GRPC_HOST
        value: pythonservice
      - key: PYTHON_GRPC_PORT
        value: 50051
      - key: GRPC_SERVER_PORT
        value: 9090
      - key: GRPC_SERVER_ADDRESS
        value: 0.0.0.0

      # JWT & Security
      - key: JWT_SIGNER_KEY
        value: OtKDnKZOdVMFihrc7TPBadUSUyR4MlycBb/Jbr58wBnfLMmUPbWyQNJN08S0kJhE
      - key: JWT_KEY_ID
        value: lingua-key-v1

      # Google & Firebase (Pointing to secretFiles mount path)
      - key: GOOGLE_CREDENTIALS_FILE_URL
        value: /etc/secrets/service-account-key.json
      - key: GOOGLE_SERVICE_ACCOUNT_FILE_URL
        value: /etc/secrets/gdrive-key.json
      - key: GOOGLE_CLIENT_ID
        value: 15162814173-kdhjp4pthjlgpcnpsliq0dgh9284maco.apps.googleusercontent.com
      - key: GOOGLE_FOLDER_ID
        value: 1BrqsnQ5vF38phPAT-8XexbsNgIzVQXOe

      # Cloudinary (Production)
      - key: PROD_CLOUDINARY_CLOUD_NAME
        value: du7euoczl
      - key: PROD_CLOUDINARY_API_KEY
        value: 737948733936564
      - key: PROD_CLOUDINARY_API_SECRET
        value: vll0SvFG3NF_0YXo-NrlOusPkG8

      # Email
      - key: MAIL_HOST
        value: smtp.gmail.com
      - key: MAIL_PORT
        value: 587
      - key: MAIL_USERNAME
        value: quyen10924@gmail.com
      - key: MAIL_PASSWORD
        value: viyh woci sbrc ddle
      - key: MAIL_SMTP_AUTH
        value: true
      - key: MAIL_STARTTLS_ENABLE
        value: true

      # Payment Gateways & External
      - key: VNPAY_TMNCODE
        value: YOUR_VNPAY_PROD_TMNCODE_HERE
      - key: VNPAY_HASHSECRET
        value: YOUR_VNPAY_PROD_HASHSECRET_HERE
      - key: VNPAY_URL
        value: https://vnpayment.vn/paymentv2/vpcpay.html
      - key: STRIPE_API_KEY
        value: sk_live_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
      - key: STRIPE_WEBHOOK_SECRET
        value: whsec_XXXXXXXXXXXXXXXXXXXXXXXXXX
      - key: TWILIO_ACCOUNT_SID
        value: VAc7bd935ea6f7e99c9396b5937e797ea2
      - key: TWILIO_AUTH_TOKEN
        value: ACbff92c92cf22146853ca99a75ff70082
      - key: TWILIO_FROM_PHONE_NUMBER
        value: +84373730397

      # App Settings
      - key: EXAM_REMINDER_HOURS_BEFORE
        value: 24
      - key: EXAM_REMINDER_REPEAT_DAYS
        value: 1
      - key: SPRING_JPA_HIBERNATE_DDL_AUTO
        value: none
      - key: SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE
        value: 200MB
      - key: SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE
        value: 200MB

  # === 2. BACKEND (PYTHON) ===
  - type: web
    name: pythonservice
    runtime: docker
    region: singapore
    plan: free
    dockerfilePath: ./PythonService/Dockerfile
    dockerContext: .
    numInstances: 1

    # Mount public key for auth verification
    secretFiles:
      - name: public_key.pem
        mountPath: /app/public_key.pem

    envVars:
      - key: TZ
        value: Asia/Ho_Chi_Minh
      - key: PORT
        value: 8001
      - key: GRPC_PORT
        value: 50051

      # Java Link
      - key: JAVA_SERVICE_URL
        value: http://linguavietnameseapp:8080
      - key: JAVA_GRPC_ADDRESS
        value: linguavietnameseapp:9090

      # Database Link
      - key: DB_HOST
        fromDatabase:
          name: linguaviet-db
          property: host
      - key: DB_PORT
        fromDatabase:
          name: linguaviet-db
          property: port
      - key: DB_NAME
        fromDatabase:
          name: linguaviet-db
          property: database
      - key: DB_USER
        fromDatabase:
          name: linguaviet-db
          property: user
      - key: DB_PASSWORD
        fromDatabase:
          name: linguaviet-db
          property: password

      # Redis Link
      - key: REDIS_HOST
        fromService:
          type: redis
          name: redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: redis
          name: redis
          property: port

  # === 3. KONG GATEWAY ===
  - type: web
    name: kong
    runtime: docker
    region: singapore
    plan: free
    dockerfilePath: ./Dockerfile.kong
    dockerContext: .
    envVars:
      - key: KONG_DATABASE
        value: "off"
      - key: KONG_DECLARATIVE_CONFIG
        value: /etc/kong/kong.yml
      - key: KONG_PROXY_LISTEN
        value: 0.0.0.0:8000
      - key: KONG_ADMIN_LISTEN
        value: 0.0.0.0:8003
      - key: KONG_PROXY_ACCESS_LOG
        value: /dev/stdout
      - key: KONG_ADMIN_ACCESS_LOG
        value: /dev/stdout
      - key: KONG_PROXY_ERROR_LOG
        value: /dev/stderr
      - key: KONG_ADMIN_ERROR_LOG
        value: /dev/stderr
      - key: KONG_PLUGINS
        value: bundled,rate-limiting,cors,request-transformer,proxy-cache
      - key: PORT
        value: 8000

  # === 4. REDIS ===
  - type: redis
    name: redis
    region: singapore
    plan: free
    ipAllowList: []

databases:
  - name: linguaviet-db
    region: singapore
    plan: free
    databaseName: linguaviet_db
    user: linguauser
    ipAllowList: []
