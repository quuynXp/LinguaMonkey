services:
  # ==========================================
  # 1. BACKEND SERVICE (JAVA)
  # ==========================================
  - type: web
    name: linguavietnameseapp
    runtime: docker
    region: singapore
    plan: free
    autoDeploy: true
    dockerContext: .
    dockerfilePath: ./LinguaVietnameseApp/Dockerfile
    envVars:
      # --- CẤU HÌNH CƠ BẢN & PORT (Render bắt buộc port 10000) ---
      - key: TZ
        value: Asia/Ho_Chi_Minh
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      - key: SERVER_PORT # Spring Boot sẽ lắng nghe ở port này
        value: 10000
      - key: PORT # Render health check port
        value: 10000

      # --- ĐỒNG BỘ VỚI DOCKER-COMPOSE: DATABASE ---
      # Docker Compose dùng: SPRING_DATASOURCE_URL
      # Ta ghép chuỗi từ các biến môi trường database của Render
      - key: DB_HOST
        fromDatabase:
          name: shared-postgres
          property: host
      - key: DB_PORT
        fromDatabase:
          name: shared-postgres
          property: port
      - key: DB_NAME
        fromDatabase:
          name: shared-postgres
          property: database
      - key: DB_USERNAME
        fromDatabase:
          name: shared-postgres
          property: user
      - key: DB_PASSWORD
        fromDatabase:
          name: shared-postgres
          property: password
      # Biến quan trọng nhất để khớp docker-compose:
      - key: SPRING_DATASOURCE_URL
        value: "jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}"

      # --- ĐỒNG BỘ VỚI DOCKER-COMPOSE: REDIS ---
      # Docker Compose dùng: SPRING_REDIS_HOST=redis
      - key: REDIS_HOST_INTERNAL
        fromService:
          type: redis
          name: redis
          property: host
      - key: SPRING_REDIS_HOST
        value: ${REDIS_HOST_INTERNAL}
      - key: REDIS_PORT
        fromService:
          type: redis
          name: redis
          property: port
      - key: REDIS_PASSWORD
        value: "redisPass123"

      # --- ĐỒNG BỘ VỚI DOCKER-COMPOSE: KẾT NỐI PYTHON ---
      # Docker Compose: PYTHON_SERVICE_URL=http://pythonservice:8001
      # Render: Phải dùng port 10000 vì pythonservice trên Render chạy port 10000
      - key: PYTHON_SERVICE_URL
        value: http://pythonservice:10000

      # --- CẤU HÌNH G-SERVICES & KHÁC (GIỮ NGUYÊN) ---
      - key: FIREBASE_CREDENTIALS_BASE64
        value: "ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAibW9ua2V5bGluZ3VhLTEwMDkiLAogICJwcml2YXRlX2tleV9pZCI6ICI1YjlhNDZiZjFmNGMyNmY5Y2FkNzg4Zjc0YzM0NjQ5ODFiMmYxMTAzIiwKICAicHJpdmF0ZV9rZXkiOiAiLS0tLS1CRUdJTiBQUklW..."
      - key: GOOGLE_CREDENTIALS_FILE_URL
        value: /app/config/service-account-key.json
      - key: GDRIVE_KEY_BASE64
        value: "ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAibW9ua2V5bGluZ3VhLTQ3NjYwNyIsCiAgInByaXZhdGVfa2V5X2lkIjogIjBhNDAyZmE2OGQyNThlMTA1YjNhYjBhZGNjNDg0NDcxZmRkNTdlNmQiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0V..."
      - key: GOOGLE_SERVICE_ACCOUNT_FILE_URL
        value: /app/config/gdrive-key.json

      # gRPC Config (Java lắng nghe 9090 nhưng internal container, public vẫn là 10000)
      - key: GRPC_SERVER_PORT
        value: 9090
      - key: GRPC_SERVER_ADDRESS
        value: 0.0.0.0
      - key: PYTHON_GRPC_HOST
        value: pythonservice
      - key: PYTHON_GRPC_PORT
        value: 50051

      # Các key khác (VNPAY, STRIPE...) giữ nguyên như cũ
      - key: VNPAY_TMNCODE
        value: 9HFGRBLQ
      - key: VNPAY_HASHSECRET
        value: 7FPX1FWZ68R9ET24K830CDU2691C7RVZ
      - key: VNPAY_URL
        value: https://sandbox.vnpayment.vn/paymentv2/vpcpay.html
      - key: STRIPE_API_KEY
        value: sk_test_51Rt1GiK4J6AVC7wy9H8RKaRG3qY6N9TnhcIHkVd7eDxcVM3xyeh9ZdynEfEdcQBe4ozHS0cfEaqvOM6JZXkHUPV2003YUKEFYK
      - key: STRIPE_WEBHOOK_SECRET
        value: whsec_u0PCrs1tLmoYcjPCraF1e0gfD7BaYQDH
      - key: JWT_SIGNER_KEY
        value: OtKDnKZOdVMFihrc7TPBadUSUyR4MlycBb/Jbr58wBnfLMmUPbWyQNJN08S0kJhE
      - key: JWT_KEY_ID
        value: lingua-key-v1
      - key: SPRING_JPA_HIBERNATE_DDL_AUTO
        value: none
      - key: GOOGLE_CLIENT_ID
        value: 15162814173-kdhjp4pthjlgpcnpsliq0dgh9284maco.apps.googleusercontent.com
      - key: GOOGLE_FOLDER_ID
        value: 1BrqsnQ5vF38phPAT-8XexbsNgIzVQXOe
      - key: PROD_CLOUDINARY_CLOUD_NAME
        value: du7euoczl
      - key: PROD_CLOUDINARY_API_KEY
        value: "737948733936564"
      - key: PROD_CLOUDINARY_API_SECRET
        value: vll0SvFG3NF_0YXo-NrlOusPkG8
      - key: MAIL_HOST
        value: smtp.gmail.com
      - key: MAIL_PORT
        value: "587"
      - key: MAIL_USERNAME
        value: quyen10924@gmail.com
      - key: MAIL_PASSWORD
        value: viyh woci sbrc ddle
      - key: EXAM_REMINDER_HOURS_BEFORE
        value: "24"
      - key: EXAM_REMINDER_REPEAT_DAYS
        value: "1"
      - key: TWILIO_ACCOUNT_SID
        value: VAc7bd935ea6f7e99c9396b5937e797ea2
      - key: TWILIO_AUTH_TOKEN
        value: ACbff92c92cf22146853ca99a75ff70082
      - key: TWILIO_FROM_PHONE_NUMBER
        value: +84373730397
      - key: KAFKA_BOOTSTRAP_SERVERS
        value: your-prod-kafka-broker-1:9092,your-prod-kafka-broker-2:9092
      - key: ELASTICSEARCH_HOST
        value: your-prod-elasticsearch-host
      - key: ELASTICSEARCH_PORT
        value: "9200"
      - key: SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE
        value: 200MB
      - key: SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE
        value: 200MB
      - key: SERVER_TOMCAT_CONNECTION_TIMEOUT
        value: 120000

    healthCheckPath: /actuator/health
    numInstances: 1

  # ==========================================
  # 2. PYTHON SERVICE
  # ==========================================
  - type: web
    name: pythonservice
    runtime: docker
    region: singapore
    plan: free
    autoDeploy: true
    dockerContext: .
    dockerfilePath: ./PythonService/Dockerfile
    envVars:
      - key: TZ
        value: Asia/Ho_Chi_Minh
      - key: PORT # Render inject, code python sẽ dùng cái này
        value: 10000

      # --- ĐỒNG BỘ VỚI DOCKER-COMPOSE ---
      # Docker Compose: DB_HOST=app-database, REDIS_HOST=redis
      - key: DB_HOST
        fromDatabase:
          name: shared-postgres
          property: host
      - key: DB_PORT
        fromDatabase:
          name: shared-postgres
          property: port
      - key: DB_NAME
        fromDatabase:
          name: shared-postgres
          property: database
      - key: DB_USER
        fromDatabase:
          name: shared-postgres
          property: user
      - key: DB_PASSWORD
        fromDatabase:
          name: shared-postgres
          property: password

      - key: REDIS_HOST
        fromService:
          type: redis
          name: redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: redis
          name: redis
          property: port
      - key: REDIS_PASSWORD
        value: "redisPass123"

      # Docker Compose: JAVA_SERVICE_URL=http://linguavietnameseapp:8080
      # Render: Đổi port 8080 thành 10000
      - key: JAVA_SERVICE_URL
        value: http://linguavietnameseapp:10000

      # gRPC (Không đổi vì đây là config nội bộ)
      - key: GRPC_PORT
        value: 50051
      - key: JAVA_GRPC_ADDRESS
        value: linguavietnameseapp:9090

      # Other vars
      - key: KAFKA_BOOTSTRAP_SERVERS
        value: your-prod-kafka-broker-1:9092,your-prod-kafka-broker-2:9092
      - key: ELASTICSEARCH_HOST
        value: your-prod-elasticsearch-host
      - key: ELASTICSEARCH_PORT
        value: "9200"

    numInstances: 1

  # ==========================================
  # 3. KONG GATEWAY
  # ==========================================
  - type: web
    name: kong
    runtime: docker
    region: singapore
    plan: free
    autoDeploy: true
    dockerContext: .
    dockerfilePath: ./Dockerfile.kong
    envVars:
      - key: PORT
        value: 8000
      - key: KONG_DATABASE
        value: "off"
      - key: KONG_DECLARATIVE_CONFIG
        value: /etc/kong/kong.yml
      - key: KONG_PROXY_LISTEN
        value: 0.0.0.0:8000
      - key: KONG_ADMIN_LISTEN
        value: 0.0.0.0:8003
      - key: KONG_PROXY_ACCESS_LOG
        value: /dev/stdout
      - key: KONG_ADMIN_ACCESS_LOG
        value: /dev/stdout
      - key: KONG_PROXY_ERROR_LOG
        value: /dev/stderr
      - key: KONG_ADMIN_ERROR_LOG
        value: /dev/stderr
      - key: KONG_PLUGINS
        value: bundled,rate-limiting,cors,request-transformer,proxy-cache
    numInstances: 1

  # ==========================================
  # 4. REDIS & POSTGRES
  # ==========================================
  - type: redis
    name: redis
    region: singapore
    plan: free
    ipAllowList: []

databases:
  - name: shared-postgres
    region: singapore
    plan: free
    databaseName: linguaviet_db
    user: linguauser
    ipAllowList: []
