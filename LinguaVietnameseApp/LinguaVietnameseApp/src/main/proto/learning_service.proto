syntax = "proto3";

package learning;

option java_package = "learning";
option java_multiple_files = true;


message ReviewQualityRequest {
  string user_id = 1;
  string content_id = 2;   // ID cho course, lesson, hoặc video
  string review_text = 3;  // Nội dung text của review
  float rating = 4;        // Điểm sao (ví dụ: 1.0 đến 5.0)
  string content_type = 5; // "COURSE", "LESSON", hoặc "VIDEO"
  Metadata metadata = 6;
}

message ReviewQualityResponse {
  bool is_valid = 1;         // Review có hợp lệ (true) hay là spam/lăng mạ (false)?
  string sentiment = 2;      // "POSITIVE", "NEUTRAL", "NEGATIVE"
  repeated string topics = 3;  // Các chủ đề được phát hiện: "sound_quality", "instructor", "content_difficulty"
  string suggested_action = 4; // Gợi ý hành động: "FLAG_FOR_MODERATION" (gắn cờ), "AUTO_APPROVE" (tự động duyệt)
  string error = 5;
}

// =====================
// Common / Base Messages
// =====================
message MediaRef {
  oneof source {
    string url = 1;
    bytes inline_data = 2;
  }
  string mime_type = 3;
  int64 size = 4;
}

message Metadata {
  map<string, string> fields = 1;
}

// =====================
// Core LearningService
// =====================
service LearningService {
    // --- Speech & Audio ---
      rpc SpeechToText (SpeechRequest) returns (SpeechResponse);
      rpc GenerateTts (TtsRequest) returns (TtsResponse);
      rpc CheckPronunciation (PronunciationRequest) returns (PronunciationResponse);

      rpc StreamPronunciation (stream PronunciationChunk) returns (stream PronunciationChunkResponse);

      // --- Text-based ---
      rpc CheckSpelling (SpellingRequest) returns (SpellingResponse);
      rpc CheckTranslation (CheckTranslationRequest) returns (CheckTranslationResponse);
      rpc CheckWritingWithImage (WritingImageRequest) returns (WritingImageResponse);
      rpc ChatWithAI (ChatRequest) returns (ChatResponse);

      // ✅ New rpc for translation (used by Java client)
      rpc Translate (TranslateRequest) returns (TranslateResponse);

      // --- Content Generation ---
      rpc GenerateImage (GenerateImageRequest) returns (GenerateImageResponse);
      rpc GenerateText (GenerateTextRequest) returns (GenerateTextResponse);
      rpc GeneratePassage (GeneratePassageRequest) returns (GeneratePassageResponse);

      // --- Personalized Learning ---
      rpc CreateOrUpdateRoadmap (RoadmapRequest) returns (RoadmapResponse);
      rpc CreateOrUpdateRoadmapDetailed (RoadmapDetailedRequest) returns (RoadmapDetailedResponse);

    // --- System-level / analytics ---
    rpc AnalyzeCourseQuality (CourseQualityRequest) returns (CourseQualityResponse);
    rpc RefundDecision (RefundDecisionRequest) returns (RefundDecisionResponse);
    rpc FindMatch (FindMatchRequest) returns (FindMatchResponse);
    rpc AnalyzeReviewQuality (ReviewQualityRequest) returns (ReviewQualityResponse);
    rpc GenerateLanguageQuiz (QuizGenerationRequest) returns (QuizGenerationResponse);
}

message CallPreferences {
  repeated string interests = 1;
  string gender = 2; // "any", "male", "female"
  string native_language = 3; // "en"
  string learning_language = 4; // "vi"
  string age_range = 5; // "18-25"
  string call_duration = 6; // "15"
}

message MatchCandidate {
  string user_id = 1;
  CallPreferences preferences = 2;
}

message FindMatchRequest {
  string current_user_id = 1;
  CallPreferences current_user_prefs = 2;
  repeated MatchCandidate candidates = 3; // Danh sách người đang chờ
  Metadata metadata = 4;
}

message FoundPartner {
  string user_id = 1;
  string fullname = 2;
  string avatar_url = 3;
  string country = 4;
  float rating = 5;
  int32 calls_completed = 6;
  string native_language = 7;
  string learning_language = 8;
  repeated string common_interests = 9;
}

message FindMatchResponse {
  bool match_found = 1;
  string partner_user_id = 2; // ID của người được AI chọn
  float compatibility_score = 3; // Độ hợp nhau (0-100)
  string reason = 4; // Lý do AI chọn (để debug hoặc hiện UI)
  string error = 5;
}

// Định nghĩa một câu hỏi quiz
message QuizQuestionProto {
  string id = 1;
  string question_text = 2;         // Nội dung câu hỏi
  repeated string options = 3;      // Danh sách 4 lựa chọn [A, B, C, D]
  int32 correct_answer_index = 4; // Index của đáp án đúng (0-3)
  string explanation = 5;         // Lý do đúng/sai
  string difficulty = 6;        // "easy", "medium", "hard"
  string skill_type = 7;        // "phonetics", "grammar", "vocabulary"
  int32 points = 8;               // Điểm cho câu hỏi này
}

// Request để tạo quiz
message QuizGenerationRequest {
  // Python sẽ dùng ID này để đọc DB và cá nhân hóa prompt
  // Để trống nếu là "team" mode
  string user_id = 1;

  int32 num_questions = 2; // 15 (solo) hoặc 30 (team)
  string mode = 3;         // "solo" hoặc "team"

  // (Optional) Chủ đề cho team mode
  string topic = 4;

  Metadata metadata = 5;
}

// Response chứa bộ câu hỏi
message QuizGenerationResponse {
  string quiz_id = 1;
  repeated QuizQuestionProto questions = 2; // Danh sách các câu hỏi
  string error = 3;
}

// =====================
// Translation
// =====================
message TranslateRequest {
  string text = 1;
  string source_language = 2;
  string target_language = 3;
  Metadata metadata = 4;
}

message TranslateResponse {
  string translated_text = 1;
  string source_language_detected = 2;
  float confidence = 3;
  string error = 4;
}

// =====================
// Audio
// =====================
message SpeechRequest {
  MediaRef audio = 1;
  string language = 2;
  Metadata metadata = 3;
}

message SpeechResponse {
  string text = 1;
  string error = 2;
}

message TtsRequest {
  string text = 1;
  string language = 2;
  Metadata metadata = 3;
}

message TtsResponse {
  bytes audio_data = 1;
  string audio_url = 2;
  string error = 3;
}

message PronunciationRequest {
  string user_id = 1;
  MediaRef audio = 2;
  string language = 3;
  Metadata metadata = 4;
  string reference_text = 5;
}

message PronunciationResponse {
  string feedback = 1;
  float score = 2;
  string ipa = 3;
  string suggestion = 4;
  string error = 5;
}

// Streaming pronunciation
message PronunciationChunk {
  bytes audio_chunk = 1;
  int32 sequence = 2;
  bool is_final = 3;
  string reference_text = 4;
}

message PronunciationChunkResponse {
  float score = 1;
  string feedback = 2;
  bool is_final = 3;
  string chunk_type = 4;
}

// =====================
// Text / Writing / Grammar
// =====================
message SpellingRequest {
  string text = 1;
  string language = 2;
  Metadata metadata = 3;
}

message SpellingResponse {
  repeated string corrections = 1;
  string explanation = 2;
  string error = 3;
}

message CheckTranslationRequest {
  string reference_text = 1;
  string translated_text = 2;
  string target_language = 3;
  Metadata metadata = 4;
}

message CheckTranslationResponse {
  string feedback = 1;
  float score = 2;
  string error = 3;
}

message WritingImageRequest {
  string text = 1;
  MediaRef image = 2;
  string language = 3;
  Metadata metadata = 4;
}

message WritingImageResponse {
  string feedback = 1;
  float score = 2;
  repeated string suggestions = 3;
  string error = 4;
}

// =====================
// Chat / Conversation
// =====================
message ChatMessage {
  string role = 1;
  string content = 2;
}

message ChatRequest {
  string user_id = 1;
  string message = 2;
  repeated ChatMessage history = 3;
  Metadata metadata = 4;
}

message ChatResponse {
  string response = 1;
  repeated string suggestions = 2;
  string emotion = 3;
  string error = 4;
}

// =====================
// Generation (AI)
// =====================
message GenerateImageRequest {
  string user_id = 1;
  string prompt = 2;
  string language = 3;
  Metadata metadata = 4;
}

message GenerateImageResponse {
  repeated string image_urls = 1;
  string model_used = 2;
  string error = 3;
}

message GenerateTextRequest {
  string user_id = 1;
  string prompt = 2;
  string language = 3;
  Metadata metadata = 4;
}

message GenerateTextResponse {
  string text = 1;
  repeated string suggestions = 2;
  string error = 3;
}

message GeneratePassageRequest {
  string user_id = 1;
  string language = 2;
  string topic = 3;
  Metadata metadata = 4;
}

message GeneratePassageResponse {
  string passage = 1;
  string difficulty = 2;
  string error = 3;
}

// =====================
// Roadmap / Learning Path
// =====================
message RoadmapItemProto {
  string item_id = 1;
  string title = 2;
  string description = 3;
  string type = 4;
  int32 level = 5;
  int32 estimated_time = 6;
  int32 order_index = 7;
  string category = 8;
  string difficulty = 9;
  int32 exp_reward = 10;
  string content_id = 11;
}

message RoadmapRequest {
  string user_id = 1;
  string roadmap_id = 2;
  string title = 3;
  string description = 4;
  string language = 5;
}

message RoadmapResponse {
  string roadmap_id = 1;
  string title = 2;
  string description = 3;
  string language = 4;
  string error = 5;
}

message RoadmapDetailedRequest {
  string user_id = 1;
  string roadmap_id = 2;
  string language = 3;
  string prompt = 4;
  bool as_user_specific = 5;
  Metadata metadata = 6;
}

message RoadmapDetailedResponse {
  string roadmap_id = 1;
  string title = 2;
  string description = 3;
  string language = 4;
  repeated RoadmapItemProto items = 5;

  // newly added lists
  repeated RoadmapResourceProto resources = 6;
  repeated RoadmapGuidanceProto guidances = 7;
  repeated RoadmapMilestoneProto milestones = 8;

  string error = 9;
}

// =====================
// Course Quality / Refunds
// =====================
message CourseQualityRequest {
  string course_id = 1;
  repeated string lesson_ids = 2;
  Metadata metadata = 3;
}

message CourseQualityResponse {
  float quality_score = 1;
  repeated string warnings = 2;
  string verdict = 3;
  string error = 4;
}

message RefundDecisionRequest {
  string transaction_id = 1;
  string user_id = 2;
  string course_id = 3;
  string reason_text = 4;
  Metadata metadata = 5;
}

message RefundDecisionResponse {
  string decision = 1;
  string label = 2;
  float confidence = 3;
  repeated string explanations = 4;
  string error = 5;
}

// --- Roadmap / Learning Path (extend)
message RoadmapResourceProto {
  string resource_id = 1;
  string item_id = 2;
  string type = 3;
  string title = 4;
  string description = 5;
  string url = 6;
  string content_id = 7;
  int32 duration = 8;
}

message RoadmapGuidanceProto {
  string guidance_id = 1;
  string item_id = 2;
  int32 stage = 3;
  string title = 4;
  string description = 5;
  repeated string tips = 6;
  int32 estimated_time = 7;
  int32 order_index = 8;
}

message RoadmapMilestoneProto {
  string milestone_id = 1;
  string title = 2;
  string description = 3;
  int32 level = 4;
  repeated string requirements = 5;
  repeated string rewards = 6;
  int32 order_index = 7;
}